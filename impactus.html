<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPACTUS - NASA Meteor Madness Challenge 2025</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 30%, #16213e 70%, #0f3460 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100vh;
        }

        .sidebar {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 2px solid rgba(255, 107, 107, 0.3);
            overflow-y: auto;
            padding: 20px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 25px;
            border-bottom: 2px solid rgba(255, 107, 107, 0.3);
        }

        .header h1 {
            font-size: 2rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .header .subtitle {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .controls {
            margin-bottom: 25px;
        }

        .controls h3 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .button-group {
            display: grid;
            gap: 8px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ff8787);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffa726, #ffb74d);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #9c27b0, #ba68c8);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .asteroid-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .asteroid-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .asteroid-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .asteroid-item.selected {
            border-color: #ffa726;
            background: rgba(255, 167, 38, 0.2);
        }

        .asteroid-name {
            font-weight: 600;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .asteroid-info {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .hazardous {
            background: rgba(255, 107, 107, 0.2) !important;
            border-color: #ff6b6b !important;
        }

        .impact-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .impact-stats {
            display: grid;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            opacity: 0.8;
        }

        .stat-value {
            font-weight: 600;
            color: #4ecdc4;
        }

        .mitigation {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #4ecdc4;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #4ecdc4;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .historical-context {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                max-height: 40vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="controls">
                <h3>üöÄ Fuentes de Datos NASA</h3>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="loadNEOData()">üîÑ Cargar NEO (7 d√≠as)</button>
                    <button class="btn btn-secondary" onclick="loadSentryData()">‚ö† Sentry Risk List</button>
                    <button class="btn btn-warning" onclick="loadHazardousOnly()">üî¥ Solo Peligrosos</button>
                    <button class="btn btn-info" onclick="loadHistoricalEvents()">üìú Eventos Hist√≥ricos</button>
                </div>
            </div>

            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>Cargando datos de asteroides...</p>
            </div>

            <div id="error" class="error hidden">
                <strong>‚ùå Error:</strong>
                <p id="error-message"></p>
            </div>

            <div id="asteroid-list" class="asteroid-list hidden">
                <h3 style="margin-bottom: 15px; color: #4ecdc4;">Asteroides Detectados</h3>
                <div id="asteroids-container"></div>
            </div>

            <div id="impact-info" class="impact-info hidden">
                <h3 style="margin-bottom: 15px; color: #ff6b6b;">üìä Simulaci√≥n de Impacto</h3>
                <div id="impact-stats" class="impact-stats"></div>
            </div>

            <div id="historical-context" class="historical-context hidden">
                <h3 style="margin-bottom: 10px; color: #ffa726;">üìö Contexto Hist√≥rico</h3>
                <p id="historical-text"></p>
            </div>

            <div id="mitigation" class="mitigation hidden">
                <h3 style="margin-bottom: 15px; color: #4ecdc4;">üõ° Mitigaci√≥n Orbital</h3>
                <div class="slider-container">
                    <label>Desviaci√≥n: <span id="deviation-value">0</span>%</label>
                    <input type="range" class="slider" id="deviation-slider" min="0" max="100" value="0">
                </div>
                <button class="btn btn-secondary" onclick="simulateDeviation()">üöÄ Simular Desviaci√≥n</button>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>üåç IMPACTUS</h1>
                <p class="subtitle">NASA Space Apps Challenge 2025 - Meteor Madness | Sistema de Simulaci√≥n de Impactos de Asteroides</p>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                <div class="map-legend">
                    <h4 style="margin-bottom: 10px; color: #4ecdc4;">Leyenda</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6b6b;"></div>
                        <span>Da√±o Total</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffa726;"></div>
                        <span>Da√±o Moderado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffeb3b;"></div>
                        <span>Da√±o Leve</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4caf50;"></div>
                        <span>Trayectoria Desviada</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==========================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ==========================================
        
        const NASA_API_KEY = 'gDbFisHOXVFSzFqoD1YTxDNgbuNVMtlLF75qoa2f';
        const NEO_API_URL = `https://api.nasa.gov/neo/rest/v1/feed?api_key=${NASA_API_KEY}`;
        
        let map;
        let currentAsteroid = null;
        let impactMarker = null;
        let damageCircles = [];
        let deviationPath = null;
        let asteroidsData = [];

        // Eventos hist√≥ricos reales para comparaci√≥n
        const HISTORICAL_EVENTS = [
            {
                name: "Cheli√°binsk (2013)",
                energy: 500, // kilotones TNT
                diameter: 20, // metros
                location: [55.1644, 61.4368],
                description: "Meteorito que explot√≥ sobre Rusia, causando da√±os en ventanas y estructuras en un radio de 200 km."
            },
            {
                name: "Tunguska (1908)",
                energy: 15000, // kilotones TNT  
                diameter: 60, // metros
                location: [60.8858, 101.8942],
                description: "Explosi√≥n que destruy√≥ 2,000 km¬≤ de bosque siberiano. Evento de impacto m√°s poderoso registrado."
            },
            {
                name: "Chicxulub (65M a√±os)",
                energy: 100000000, // kilotones TNT
                diameter: 10000, // metros
                location: [21.4, -89.5],
                description: "Asteroide que caus√≥ la extinci√≥n de los dinosaurios. Crater de 180 km de di√°metro."
            }
        ];

        // Datos simulados del sistema CNEOS Sentry
        const SENTRY_OBJECTS = [
            {
                name: "2023 DW",
                diameter: 50,
                velocity: 25,
                density: 2.6,
                date: "2046-02-14",
                probability: "1 en 560",
                energy: 1200
            },
            {
                name: "Apophis",
                diameter: 340,
                velocity: 30,
                density: 2.6,
                date: "2029-04-13",
                probability: "0% (actualizado)",
                energy: 880000
            },
            {
                name: "2022 AP7",
                diameter: 1500,
                velocity: 22,
                density: 2.6,
                date: "Desconocido",
                probability: "Bajo riesgo",
                energy: 12000000
            }
        ];

        // ==========================================
        // INICIALIZACI√ìN DEL MAPA
        // ==========================================
        
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors | NASA Space Apps Challenge 2025'
            }).addTo(map);

            console.log('Mapa inicializado correctamente');
        }

        // ==========================================
        // FUNCIONES DE INTERFAZ
        // ==========================================
        
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            hideLoading();
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toFixed(0);
        }

        // ==========================================
        // C√ÅLCULOS CIENT√çFICOS
        // ==========================================
        
        function calculateImpactEnergy(diameter, velocity, density = 2.6) {
            // C√°lculo de energ√≠a cin√©tica: E = 1/2 * m * v¬≤
            const volume = (4/3) * Math.PI * Math.pow(diameter/2, 3); // m¬≥
            const mass = volume * density * 1000; // kg (densidad en g/cm¬≥ -> kg/m¬≥)
            const velocityMs = velocity * 1000; // km/s -> m/s
            const energy = 0.5 * mass * Math.pow(velocityMs, 2); // Joules
            const energyTNT = energy / 4.184e12; // Conversi√≥n a kilotones TNT
            
            return {
                energy: energy,
                energyTNT: energyTNT,
                mass: mass
            };
        }

        function calculateDamageRadii(energyTNT) {
            // Basado en f√≥rmulas de explosiones nucleares adaptadas para asteroides
            const totalRadius = 1.8 * Math.pow(energyTNT, 0.33); // km
            const moderateRadius = 3.2 * Math.pow(energyTNT, 0.33); // km  
            const lightRadius = 5.5 * Math.pow(energyTNT, 0.33); // km
            
            return {
                total: Math.min(totalRadius, 100), // L√≠mite m√°ximo para visualizaci√≥n
                moderate: Math.min(moderateRadius, 200),
                light: Math.min(lightRadius, 500)
            };
        }

        function assessConsequences(energyTNT, location) {
            const consequences = [];
            
            if (energyTNT > 100) {
                consequences.push("üåä Posible tsunami si impacta en oc√©ano");
            }
            if (energyTNT > 500) {
                consequences.push("üåã Actividad s√≠smica regional");
            }
            if (energyTNT > 10000) {
                consequences.push("üå® Invierno por impacto (polvo atmosf√©rico)");
            }
            if (energyTNT > 100000) {
                consequences.push("üåç Cambios clim√°ticos globales");
            }
            if (energyTNT > 1000000) {
                consequences.push("üíÄ Extinci√≥n masiva potencial");
            }
            
            return consequences;
        }

        function findHistoricalComparison(energyTNT) {
            const comparisons = HISTORICAL_EVENTS.filter(event => 
                Math.abs(Math.log10(event.energy) - Math.log10(energyTNT)) < 1
            );
            
            if (comparisons.length > 0) {
                const closest = comparisons.reduce((prev, curr) => 
                    Math.abs(curr.energy - energyTNT) < Math.abs(prev.energy - energyTNT) ? curr : prev
                );
                return closest;
            }
            
            // Si no hay comparaci√≥n cercana, encontrar el m√°s cercano
            return HISTORICAL_EVENTS.reduce((prev, curr) => 
                Math.abs(curr.energy - energyTNT) < Math.abs(prev.energy - energyTNT) ? curr : prev
            );
        }

        // ==========================================
        // FUNCIONES DE CARGA DE DATOS
        // ==========================================
        
        async function loadNEOData() {
            showLoading();
            
            try {
                const response = await fetch(NEO_API_URL);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                const neoData = [];
                
                // Procesar datos de los pr√≥ximos 7 d√≠as
                Object.keys(data.near_earth_objects).forEach(date => {
                    data.near_earth_objects[date].forEach(neo => {
                        const closeApproach = neo.close_approach_data[0];
                        neoData.push({
                            name: neo.name,
                            diameter: parseFloat(neo.estimated_diameter.meters.estimated_diameter_max),
                            velocity: parseFloat(closeApproach.relative_velocity.kilometers_per_second),
                            distance: parseFloat(closeApproach.miss_distance.kilometers),
                            hazardous: neo.is_potentially_hazardous_asteroid,
                            date: closeApproach.close_approach_date,
                            type: 'neo'
                        });
                    });
                });
                
                asteroidsData = neoData;
                displayAsteroids(neoData);
                hideLoading();
                
            } catch (error) {
                console.error('Error loading NEO data:', error);
                showError('Error al cargar datos NEO: ' + error.message);
            }
        }

        function loadSentryData() {
            showLoading();
            
            // Simular carga de datos CNEOS Sentry
            setTimeout(() => {
                const sentryData = SENTRY_OBJECTS.map(obj => ({
                    name: obj.name,
                    diameter: obj.diameter,
                    velocity: obj.velocity,
                    distance: 0, // Ya est√°n marcados como riesgo
                    hazardous: true,
                    date: obj.date,
                    probability: obj.probability,
                    type: 'sentry'
                }));
                
                asteroidsData = sentryData;
                displayAsteroids(sentryData);
                hideLoading();
            }, 1000);
        }

        function loadHazardousOnly() {
            if (asteroidsData.length === 0) {
                showError('Primero carga algunos datos');
                return;
            }
            
            const hazardousData = asteroidsData.filter(asteroid => asteroid.hazardous);
            displayAsteroids(hazardousData);
        }

        function loadHistoricalEvents() {
            showLoading();
            
            setTimeout(() => {
                const historicalData = HISTORICAL_EVENTS.map(event => ({
                    name: event.name,
                    diameter: event.diameter,
                    velocity: 20, // Velocidad estimada
                    distance: 0,
                    hazardous: true,
                    date: 'Evento hist√≥rico',
                    location: event.location,
                    type: 'historical'
                }));
                
                asteroidsData = historicalData;
                displayAsteroids(historicalData);
                hideLoading();
            }, 500);
        }

        // ==========================================
        // VISUALIZACI√ìN DE DATOS
        // ==========================================
        
        function displayAsteroids(asteroids) {
            const container = document.getElementById('asteroids-container');
            const listDiv = document.getElementById('asteroid-list');
            
            container.innerHTML = '';
            
            if (asteroids.length === 0) {
                container.innerHTML = '<p style="opacity: 0.6;">No se encontraron asteroides</p>';
                listDiv.classList.remove('hidden');
                return;
            }
            
            asteroids.forEach((asteroid, index) => {
                const div = document.createElement('div');
                div.className = `asteroid-item ${asteroid.hazardous ? 'hazardous' : ''}`;
                div.onclick = () => selectAsteroid(asteroid);
                
                div.innerHTML = `
                    <div class="asteroid-name">${asteroid.name}</div>
                    <div class="asteroid-info">
                        üìè ${asteroid.diameter.toFixed(0)}m | 
                        ‚ö° ${asteroid.velocity.toFixed(1)} km/s |
                        üìÖ ${asteroid.date}
                        ${asteroid.hazardous ? ' | ‚ö† PELIGROSO' : ''}
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            listDiv.classList.remove('hidden');
        }

        function selectAsteroid(asteroid) {
            currentAsteroid = asteroid;
            
            // Actualizar selecci√≥n visual
            document.querySelectorAll('.asteroid-item').forEach(item => 
                item.classList.remove('selected'));
            event.target.closest('.asteroid-item').classList.add('selected');
            
            // Simular impacto
            simulateImpact(asteroid);
        }

        function simulateImpact(asteroid) {
            // Limpiar marcadores anteriores
            clearMapMarkers();
            
            // Generar ubicaci√≥n de impacto aleatoria (o usar hist√≥rica si existe)
            let impactLocation;
            if (asteroid.location) {
                impactLocation = asteroid.location;
            } else {
                impactLocation = [
                    (Math.random() - 0.5) * 120, // Latitud -60 a 60
                    (Math.random() - 0.5) * 360  // Longitud -180 a 180
                ];
            }
            
            // Calcular energ√≠a y radios de da√±o
            const impact = calculateImpactEnergy(asteroid.diameter, asteroid.velocity);
            const radii = calculateDamageRadii(impact.energyTNT);
            const consequences = assessConsequences(impact.energyTNT, impactLocation);
            const historical = findHistoricalComparison(impact.energyTNT);
            
            // Mostrar punto de impacto
            impactMarker = L.marker(impactLocation).addTo(map)
                .bindPopup(`<b>üéØ Punto de Impacto</b><br/>${asteroid.name}`)
                .openPopup();
            
            // Mostrar c√≠rculos de da√±o
            const colors = ['#ff6b6b', '#ffa726', '#ffeb3b'];
            const radiiValues = [radii.total, radii.moderate, radii.light];
            
            radiiValues.forEach((radius, index) => {
                if (radius > 0) {
                    const circle = L.circle(impactLocation, {
                        color: colors[index],
                        fillColor: colors[index],
                        fillOpacity: 0.2,
                        radius: radius * 1000 // km to meters
                    }).addTo(map);
                    damageCircles.push(circle);
                }
            });
            
            // Centrar mapa en el impacto
            map.setView(impactLocation, 6);
            
            // Mostrar informaci√≥n de impacto
            displayImpactInfo(impact, radii, consequences, historical);
            
            // Mostrar controles de mitigaci√≥n
            document.getElementById('mitigation').classList.remove('hidden');
        }

        function displayImpactInfo(impact, radii, consequences, historical) {
            const statsContainer = document.getElementById('impact-stats');
            const infoDiv = document.getElementById('impact-info');
            const contextDiv = document.getElementById('historical-context');
            const contextText = document.getElementById('historical-text');
            
            statsContainer.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">üí• Energ√≠a de Impacto</span>
                    <span class="stat-value">${formatNumber(impact.energyTNT)} kilotones TNT</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üéØ Radio Destrucci√≥n Total</span>
                    <span class="stat-value">${radii.total.toFixed(1)} km</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‚ö† Radio Da√±o Moderado</span>
                    <span class="stat-value">${radii.moderate.toFixed(1)} km</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üí® Radio Da√±o Leve</span>
                    <span class="stat-value">${radii.light.toFixed(1)} km</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‚öñ Masa del Asteroide</span>
                    <span class="stat-value">${formatNumber(impact.mass)} kg</span>
                </div>
                ${consequences.length > 0 ? `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <strong>üåç Consecuencias:</strong>
                    <div style="margin-top: 10px;">
                        ${consequences.map(c => `<div style="margin: 5px 0;">${c}</div>`).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Mostrar contexto hist√≥rico
            const ratio = impact.energyTNT / historical.energy;
            let comparison;
            if (ratio > 2) {
                comparison = `${ratio.toFixed(1)}x m√°s poderoso que`;
            } else if (ratio < 0.5) {
                comparison = `${(1/ratio).toFixed(1)}x menos poderoso que`;
            } else {
                comparison = "similar en magnitud a";
            }
            
            contextText.innerHTML = `
                Este impacto ser√≠a <strong>${comparison}</strong> el evento de <strong>${historical.name}</strong>.<br/><br/>
                <em>${historical.description}</em>
            `;
            
            infoDiv.classList.remove('hidden');
            contextDiv.classList.remove('hidden');
        }

        // ==========================================
        // SISTEMA DE MITIGACI√ìN
        // ==========================================
        
        function simulateDeviation() {
            if (!currentAsteroid || !impactMarker) {
                showError('Primero selecciona un asteroide para simular');
                return;
            }
            
            const deviationPercent = document.getElementById('deviation-slider').value;
            
            if (deviationPercent == 0) {
                showError('Ajusta el slider de desviaci√≥n');
                return;
            }
            
            // Limpiar trayectoria anterior
            if (deviationPath) {
                map.removeLayer(deviationPath);
            }
            
            // Calcular nueva ubicaci√≥n basada en desviaci√≥n
            const originalLat = impactMarker.getLatLng().lat;
            const originalLng = impactMarker.getLatLng().lng;
            
            // Desviaci√≥n proporcional (simplificada)
            const deviationFactor = deviationPercent / 100;
            const newLat = originalLat + (Math.random() - 0.5) * deviationFactor * 20;
            const newLng = originalLng + (Math.random() - 0.5) * deviationFactor * 40;
            
            // Nuevo punto de impacto
            const newImpactLocation = [newLat, newLng];
            
            // Marcador del nuevo impacto
            const newImpactMarker = L.marker(newImpactLocation, {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiM0Y2FmNTAiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNCIgZmlsbD0iI2ZmZmZmZiIvPgo8L3N2Zz4K',
                    iconSize: [25, 25]
                })
            }).addTo(map)
              .bindPopup(`<b>üéØ Nuevo Punto de Impacto</b><br/>Desviaci√≥n: ${deviationPercent}%`)
              .openPopup();
            
            // L√≠nea de trayectoria desviada
            deviationPath = L.polyline([
                [originalLat, originalLng],
                [newLat, newLng]
            ], {
                color: '#4caf50',
                weight: 3,
                dashArray: '10, 10'
            }).addTo(map);
            
            // Ajustar vista para mostrar ambos puntos
            const group = new L.featureGroup([impactMarker, newImpactMarker]);
            map.fitBounds(group.getBounds().pad(0.1));
            
            // Guardar referencia del nuevo marcador
            damageCircles.push(newImpactMarker);
        }

        function clearMapMarkers() {
            if (impactMarker) {
                map.removeLayer(impactMarker);
                impactMarker = null;
            }
            
            damageCircles.forEach(circle => map.removeLayer(circle));
            damageCircles = [];
            
            if (deviationPath) {
                map.removeLayer(deviationPath);
                deviationPath = null;
            }
        }

        // ==========================================
        // EVENTOS Y INICIALIZACI√ìN
        // ==========================================
        
        // Actualizar valor del slider
        document.getElementById('deviation-slider').addEventListener('input', function() {
            document.getElementById('deviation-value').textContent = this.value;
        });

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando IMPACTUS - NASA Space Apps Challenge 2025');
            initMap();
            
            // Cargar datos NEO autom√°ticamente
            setTimeout(() => {
                console.log('Cargando datos iniciales...');
                loadNEOData();
            }, 1000);
        });

        // Funciones globales
        window.loadNEOData = loadNEOData;
        window.loadSentryData = loadSentryData;
        window.loadHazardousOnly = loadHazardousOnly;
        window.loadHistoricalEvents = loadHistoricalEvents;
        window.simulateDeviation = simulateDeviation;
        
        console.log('‚úÖ IMPACTUS cargado correctamente');
    </script>
</body>
</html>